# Prompt Templates for Invoice/Receipt Processing

detailed_invoice:
  name: "Comprehensive Document Extraction"
  description: "Extract all fields from invoices, receipts, and business documents with advanced validation"
  system_prompt: |
    You are an expert at analyzing invoices, receipts, and business documents with exceptional attention to detail.
    Your ONLY task is to extract structured data as valid JSON.

    CRITICAL JSON FORMATTING REQUIREMENTS:
    - Your response must be EXACTLY a JSON object starting with a single opening brace and ending with a single closing brace
    - EVERY property name must be enclosed in double quotes: "property_name"
    - EVERY string value must be enclosed in double quotes: "string_value"
    - Use null (no quotes) for missing values, not "null" or "N/A"
    - Use [] (empty array) for empty line_items, not null
    - NO single quotes - only double quotes for strings
    - NO trailing commas anywhere in the JSON
    - NO comments or explanations - pure JSON only
    - Your very first character must be a single opening brace and your very last character must be a single closing brace
    - Test the JSON syntax mentally - it must pass JSON.parse()

  user_prompt: |
    Analyze this invoice/receipt/business document image and extract comprehensive information.

    CRITICAL GENERAL RULES:
    - FIRST, internally identify every date-like string and its surrounding text on the document.
    - THEN, map those dates to the fields below. NEVER leave a date field null if a clear candidate exists.
    - Use null for a date ONLY if there is no relevant date-like text or it is completely illegible.
    - Normalize all dates you output to ISO format YYYY-MM-DD, regardless of the original format.
    - If multiple candidates exist for a field, choose the best match based on nearby labels and context.

    CRITICAL DATE FORMAT DISAMBIGUATION:
    - For ambiguous formats like "01/02/2024" or "03/05/2024", use these context clues:
      • Company location: European companies (Hungary, Germany, Austria, etc.) likely use DD/MM/YYYY
      • US companies likely use MM/DD/YYYY
      • Language context: Slovenian, German, Hungarian text suggests DD/MM/YYYY
      • Logical validation: If interpreted as MM/DD results in invalid date (month >12), use DD/MM
      • Document type patterns: European invoices typically use DD/MM, US invoices use MM/DD
    - ALWAYS validate: If day >12, the format MUST be MM/DD/YYYY
    - ALWAYS validate: If month >12, the format MUST be DD/MM/YYYY
    - Supported input formats: DD.MM.YYYY, DD/MM/YYYY, DD-MM-YYYY, MM/DD/YYYY, YYYY-MM-DD, YYYY.MM.DD, and localized variants with month names
    - When uncertain, prefer the format that matches the company's likely geographic origin

    CRITICAL ADDRESS RULES:
    - ALL addresses MUST be complete with: street + number, city, postal code, and country.
    - NEVER output addresses like just "Budapest" or "Berlin".
    - Use a single string format with commas, e.g. "Sarló u 7, Székesfehérvár 8000, Hungary".
    - Always use full country names (e.g. "United States", not "US").
    - EXCLUDE personal names from addresses: Remove names like "Mr. John Smith", "Att: Mary Johnson", "c/o Peter Brown" or similar personal contact names that appear in address blocks.

    REQUIRED CORE FIELDS:
    - invoice_number: The invoice/receipt number or transaction ID
    - invoice_date: The date of the invoice/receipt (format: YYYY-MM-DD)
    - due_date: The payment due date (format: YYYY-MM-DD), if available
        • Look explicitly for labels like "due date", "payment due", "datum valute" (Slovenian).
    - payment_date: The date payment was made (format: YYYY-MM-DD), if available
        • Look explicitly for "payment date", "date paid", "transaction date", bank statement dates, etc.
    - service_date: The date when services were performed (format: YYYY-MM-DD), if available
        • Look for labels like "service date", "performed on", "delivery date"
        • Slovenian hints: "odprema blaga", "odp. blaga", "opravljena storitev", "opravljene storitve", "opr. storitve", "storitev", "storitve"
    - service_provider: Object with:
        • name
        • address (complete, as a single string with street + number, city, postal code, country)
        • tax_id (if available)
        • contact details (if available: email, phone, website)
    - buyer: Object with:
        • name
        • address (complete if available)
        • contact details (if available)
        If not explicitly labeled, infer the buyer from the document context.
    - amount: The total amount paid (numeric value only, no currency symbol)
    - currency: Currency code (e.g. "USD", "EUR", "GBP")
    - description: Brief description of services/products OR a summary of line items for receipts
    - payment_method: One of: "creditcard", "banktransfer", "cash", "other", "N/A"
        • Slovenian hints: "kartice", "kreditna kartica" = "creditcard"; "virman" = "banktransfer"
    - paymentBankAccountNumber: (ONLY if payment_method is "banktransfer") Bank account/IBAN where payment should be sent
    - paymentReference: (ONLY if payment_method is "banktransfer") Payment reference or communication line to include with the bank transfer
    - line_items: Array of items/services, each object with:
        • description
        • quantity
        • unit_price (net price per unit WITHOUT VAT/TAX)
        • total (net total for this line WITHOUT VAT/TAX)
        • tax_rate (percentage for this line item, if specified)
    - subtotal: Subtotal amount before taxes (sum of all line item totals)
    - tax_amount: Total tax amount
    - tax_rate: Overall tax rate percentage (if uniform across all items)
    - total_amount: Final total amount including taxes

    {buyer_context}

    OUTPUT FORMAT:
    - Return ONLY a valid JSON object with exactly these top-level keys:
      [
        "invoice_number",
        "invoice_date",
        "due_date",
        "payment_date",
        "service_date",
        "service_provider",
        "buyer",
        "amount",
        "currency",
        "description",
        "payment_method",
        "paymentBankAccountNumber",
        "paymentReference",
        "line_items",
        "subtotal",
        "tax_amount",
        "tax_rate",
        "total_amount"
      ]
    - For any field that does not apply or is not found, use null.
    - For "line_items", use an empty array [] if there are no line items.

    EXACT OUTPUT FORMAT EXAMPLE:
    {{
      "invoice_number": "INV-2024-001",
      "invoice_date": "2024-01-15",
      "due_date": null,
      "payment_date": null,
      "service_date": "2024-01-10",
      "service_provider": {{
        "name": "Company Name",
        "address": "Street 123, City 12345, Country",
        "tax_id": "TAX123456",
        "contact": null
      }},
      "buyer": null,
      "amount": 1500.00,
      "currency": "EUR",
      "description": "Services provided",
      "payment_method": "banktransfer",
      "paymentBankAccountNumber": "DE89370400440532013000",
      "paymentReference": "INV-2024-001",
      "line_items": [],
      "subtotal": null,
      "tax_amount": null,
      "tax_rate": null,
      "total_amount": null
    }}

    CRITICAL: Your response must be identical in structure to the example above - valid JSON with proper double quotes, no trailing commas, and exact field names.

    IMPORTANT RULES FOR payment_method "banktransfer":
    1. paymentBankAccountNumber:
       - Extract the account / IBAN number.
       - Remove all spaces, dashes, and special characters.
       - Keep only letters and numbers.
       - Do NOT include bank name or other text.
    2. paymentReference:
       - Extract the exact reference text that should be used in the bank transfer.
       - Look for labels like "Payment Communication:", "Communication:", "Reference:", "Payment Reference:", "Structured Communication:", "Sklic", "Reference number".
       - Do NOT include the label itself, only the value.

    POSITIVE PAYMENT EXAMPLES:

    Example 1 - Basic bank transfer:
    Input text: "Payment Communication: INV/2025/01579 on this account: BE07 9050 4713 8266 - Wise EUR"
    Correct output:
    {{
      "payment_method": "banktransfer",
      "paymentBankAccountNumber": "BE07905047138266",
      "paymentReference": "INV/2025/01579"
    }}

    Example 2 - Structured reference:
    Input text: "Please transfer to IBAN: DE89 3704 0044 0532 0130 00 with reference: Invoice-2024-ABC-123"
    Correct output:
    {{
      "payment_method": "banktransfer",
      "paymentBankAccountNumber": "DE89370400440532013000",
      "paymentReference": "Invoice-2024-ABC-123"
    }}

    Example 3 - Payment reference with special format:
    Input text: "Account: GB29 NWBK 6016 1331 9268 19, Payment note: REF-2025/Q1/789"
    Correct output:
    {{
      "payment_method": "banktransfer",
      "paymentBankAccountNumber": "GB29NWBK60161331926819",
      "paymentReference": "REF-2025/Q1/789"
    }}

    Example 4 - Multiple reference formats:
    Input text: "Structured communication: +++123/4567/89012+++ Bank: BE71 0961 2345 6769"
    Correct output:
    {{
      "payment_method": "banktransfer",
      "paymentBankAccountNumber": "BE71096123456769",
      "paymentReference": "+++123/4567/89012+++"
    }}

    DATE FORMAT DISAMBIGUATION EXAMPLES:

    Example 1 - Clear validation:
    "15/03/2024" → Day >12, so MUST be DD/MM/YYYY → "2024-03-15"

    Example 2 - Invalid month validation:
    "05/13/2024" → Month >12, so MUST be MM/DD/YYYY → "2024-05-13"

    Example 3 - Geographic context:
    Document from "Budapest, Hungary" showing "08/03/2024"
    → European company likely uses DD/MM → "2024-03-08"

    Example 4 - Geographic context:
    Document from "New York, USA" showing "08/03/2024"
    → US company likely uses MM/DD → "2024-08-03"

    Example 5 - Language context:
    Document with Slovenian text "datum valute: 12/05/2024"
    → Slovenian suggests European format DD/MM → "2024-05-12"

    POSITIVE ADDRESS EXAMPLES:

    {{
      "service_provider": {{
        "name": "Example Company Ltd",
        "address": "Main Street 123, Example City 12345, Country"
      }}
    }}

    {{
      "service_provider": {{
        "name": "Sample Business Inc",
        "address": "Business Avenue 456, Sample Town 67890, Country"
      }}
    }}

    CORRECT address extraction (removing personal names):
    Document shows:
    "ABC Company Ltd
    Att: Mr. John Smith
    123 Business Street
    New York, NY 10001
    United States"

    Extract as:
    {{
      "service_provider": {{
        "name": "ABC Company Ltd",
        "address": "123 Business Street, New York, NY 10001, United States"
      }}
    }}

    NEGATIVE ADDRESS EXAMPLES (avoid these):

    {{
      "service_provider": {{
        "name": "Company Name",
        "address": "Budapest"
      }}
    }}

    {{
      "service_provider": {{
        "name": "Business Name",
        "address": "Main Street 123, Berlin 10117"
      }}
    }}

    {{
      "service_provider": "Just Company Name"
    }}

    WRONG - Including personal names in address:
    {{
      "service_provider": {{
        "name": "ABC Company Ltd",
        "address": "Att: Mr. John Smith, 123 Business Street, New York, NY 10001, United States"
      }}
    }}

debug_text_extraction:
  name: "Debug Text Extraction"
  description: "Extract and interpret all text for debugging purposes"
  system_prompt: |
    You are a text analysis expert that extracts all readable text from documents and provides interpretations.
    Your goal is to help debug OCR and text processing issues by providing detailed text analysis.

  user_prompt: |
    Extract ALL readable text from this document and provide detailed analysis for debugging purposes.

    Return a JSON object with the following structure:
    {{
      "extracted_text": "All readable text from the document, preserving line breaks and formatting as much as possible",
      "text_sections": [
        {{
          "section_type": "header|footer|body|table|address|date|number|etc",
          "content": "The actual text content",
          "interpretation": "What this text likely represents (e.g., 'invoice number', 'company address', 'date', 'amount', etc.)",
          "confidence": "high|medium|low - how confident you are in the interpretation"
        }}
      ],
      "identified_patterns": {{
        "dates_found": ["list of all date-like text found"],
        "numbers_found": ["list of all numeric values found"],
        "addresses_found": ["list of all address-like text found"],
        "company_names_found": ["list of potential company/business names"],
        "slovenian_terms": ["list of any Slovenian words/phrases detected"],
        "payment_terms": ["list of any payment-related terms found"]
      }},
      "potential_issues": [
        "List any text that appears unclear, partially obscured, or difficult to read",
        "Note any formatting issues that might affect processing"
      ]
    }}

    Be extremely thorough in text extraction. Include:
    - Headers and footers
    - Watermarks if visible
    - Table headers and data
    - Fine print and small text
    - Any partially visible or unclear text (mark as such)
    - Numbers, dates, addresses, names
    - Special characters and symbols

    For interpretations, consider:
    - Context and positioning of text
    - Common invoice/receipt patterns
    - Slovenian business terminology
    - Date formats (DD.MM.YYYY, DD/MM/YYYY, etc.)
    - Currency and amount patterns
    - Address formatting patterns

    {buyer_context}

    Return ONLY the JSON object, no additional text.
